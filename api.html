<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Notification API (Query Mode)</title>
</head>
<body>
    <script>
        /**
         * クエリパラメータを取得する関数
         * 例: ?app=WHU&date=2026~2~13&type=content
         */
        function getQueryParam(name) {
            var params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        // データの取得と表示
        (function() {
            var appID = getQueryParam('app');
            var dateStr = getQueryParam('date');
            var type = getQueryParam('type');

            // パラメータが不足している場合はエラー
            if (!appID || !dateStr || !type) {
                document.body.innerText = "#Err#";
                return;
            }

            // 日付のパース (YYYY~MM~DD)
            var dateParts = dateStr.split('~').map(Number);
            
            var xhr = new XMLHttpRequest();
            // 実行環境に合わせた絶対パスの構築
            var targetUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1) + 'info/notifications.json';
            
            xhr.open('GET', targetUrl, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var notifications = JSON.parse(xhr.responseText);
                            var match = null;

                            // 条件に一致する通知を検索
                            for (var i = 0; i < notifications.length; i++) {
                                var n = notifications[i];
                                if (n.appkind === appID && 
                                    n.date &&
                                    n.date[0] === dateParts[0] && 
                                    n.date[1] === dateParts[1] && 
                                    n.date[2] === dateParts[2]) {
                                    match = n;
                                    break;
                                }
                            }

                            // 結果の出力
                            if (match) {
                                if (type === 'title') {
                                    document.body.innerText = match.title;
                                } else if (type === 'content') {
                                    document.body.innerText = match.content;
                                } else if (type === 'priority') {
                                    document.body.innerText = match.priority;
                                } else {
                                    document.body.innerText = "#Err#";
                                }
                            } else {
                                // 見つからない場合は空文字
                                document.body.innerText = "";
                            }
                        } catch (e) {
                            // 解析失敗時
                            document.body.innerText = "#Err#";
                        }
                    } else {
                        // 通信失敗時
                        document.body.innerText = "#Err#";
                    }
                }
            };
            xhr.send();
        })();
    </script>
</body>
</html>
